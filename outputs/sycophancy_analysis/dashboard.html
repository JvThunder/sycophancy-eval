<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Sycophancy (MCQ) Metrics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        h1 {
            margin-top: 0;
        }

        table {
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 4px 8px;
        }

        th {
            background: #f2f2f2;
        }

        #questionTable {
            margin-top: 10px;
            max-height: 350px;
            overflow-y: auto;
            display: block;
        }

        #questionTable thead,
        #questionTable tbody {
            display: block;
        }

        #questionTable tbody {
            overflow-y: auto;
            max-height: 300px;
        }

        #questionTable td {
            min-width: 120px;
        }
    </style>
</head>

<body>
    <h1>Sycophancy (MCQ) Metrics Dashboard</h1>

    <label for="modelSelect"><strong>Select model run:</strong></label>
    <select id="modelSelect"></select>

    <h2>Overall statistics</h2>
    <table id="statsTable">
        <thead>
            <tr>
                <th>Metric</th>
                <th>Value</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h2>Difference-jump counts</h2>
    <canvas id="jumpChart" width="640" height="320"></canvas>

    <h2>Accuracy comparison across models</h2>
    <canvas id="accuracyChart" width="640" height="320"></canvas>

    <h2>Question-level statistics</h2>
    <details open>
        <summary>Toggle table</summary>
        <table id="questionTable">
            <thead>
                <tr>
                    <th>Question&nbsp;ID</th>
                    <th>Before&nbsp;mean</th>
                    <th>After&nbsp;mean</th>
                    <th>Diff&nbsp;mean</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </details>

    <p style="color:#666; font-size:0.9em; margin-top: 32px;">
        Tip: If the browser blocks loading of local JSON files, serve this folder with a simple server
        (e.g.&nbsp;<code>python -m http.server</code>) and open <code>http://localhost:8000</code>.
    </p>

    <script>
        // Mapping of display label to JSON filename (relative to this HTML file)
        const fileMap = [
            { label: "deepseek-chat", path: "sycophancy_deepseek-chat_20250617-162535_20250624-163448.json" },
            { label: "gpt-4o-mini", path: "sycophancy_gpt-4o-mini_20250617-150409_20250624-163448.json" },
            { label: "claude-3-5-haiku", path: "sycophancy_claude-3-5-haiku-latest_20250617-180213_20250624-163448.json" },
            { label: "gpt-4o", path: "sycophancy_gpt-4o_20250617-152505_20250624-163448.json" },
            { label: "o4-mini", path: "sycophancy_o4-mini_20250617-121458_20250624-163448.json" },
        ];

        const modelSelect = document.getElementById("modelSelect");
        const statsBody = document.querySelector("#statsTable tbody");
        const qBody = document.querySelector("#questionTable tbody");
        let jumpChart, accuracyChart;

        // Populate <select>
        fileMap.forEach((f, idx) => {
            const opt = document.createElement("option");
            opt.value = idx;
            opt.textContent = f.label;
            modelSelect.appendChild(opt);
        });

        // Load all JSON files in parallel
        Promise.all(
            fileMap.map(f => fetch(f.path).then(r => {
                if (!r.ok) throw new Error(`Failed to load ${f.path}`);
                return r.json();
            }))
        ).then(jsonArr => {
            jsonArr.forEach((js, i) => fileMap[i].data = js);
            // After all loaded: build accuracy chart
            renderAccuracyChart();
            // Initial render
            updateView(0);
            modelSelect.addEventListener("change", e => updateView(+e.target.value));
        }).catch(err => {
            console.error(err);
            alert("Error loading JSON files â€“ see console for details.  If you're opening this file directly, try running a local web-server instead.");
        });

        function updateView(idx) {
            const dataset = fileMap[idx].data;
            if (!dataset) return;
            renderStats(dataset.overall_stats);
            renderJumpChart(dataset.overall_stats.difference_jump_counts || {});
            renderQuestionStats(dataset.question_stats);
        }

        // ----- overall-stats table -----
        function renderStats(stats) {
            statsBody.innerHTML = "";
            const metricKeys = [
                "mean_before_score",
                "mean_after_score",
                "mean_difference",
                "accuracy",
                "overall_consistency_before",
                "overall_consistency_after"
            ];
            metricKeys.forEach(k => {
                const tr = document.createElement("tr");
                const name = k.replace(/_/g, " ");
                const rawVal = stats[k];
                const val = (typeof rawVal === "number") ? rawVal.toFixed(3) : (rawVal ?? "-");
                tr.innerHTML = `<td>${name}</td><td>${val}</td>`;
                statsBody.appendChild(tr);
            });
        }

        // ----- bar chart for jump counts -----
        function renderJumpChart(counts) {
            const labels = Object.keys(counts).sort();
            const values = labels.map(l => counts[l]);
            if (!jumpChart) {
                jumpChart = new Chart(document.getElementById("jumpChart").getContext("2d"), {
                    type: "bar",
                    data: { labels, datasets: [{ label: "Count", data: values, backgroundColor: "#4e79a7" }] },
                    options: { responsive: false, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
                });
            } else {
                jumpChart.data.labels = labels;
                jumpChart.data.datasets[0].data = values;
                jumpChart.update();
            }
        }

        // Utility formatter for nullable numeric values
        function fmt(x) {
            return (typeof x === "number") ? x.toFixed(2) : "-";
        }

        // ----- question-level table -----
        function renderQuestionStats(qStats) {
            qBody.innerHTML = "";
            Object.entries(qStats).forEach(([qid, obj]) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${qid}</td><td>${fmt(obj.before_score_mean)}</td><td>${fmt(obj.after_score_mean)}</td><td>${fmt(obj.difference_mean)}</td>`;
                qBody.appendChild(tr);
            });
        }

        // ----- accuracy comparison chart -----
        function renderAccuracyChart() {
            const labels = fileMap.map(f => f.label);
            const values = fileMap.map(f => f.data.overall_stats.accuracy ?? 0);
            accuracyChart = new Chart(document.getElementById("accuracyChart").getContext("2d"), {
                type: "bar",
                data: { labels, datasets: [{ label: "Accuracy", data: values, backgroundColor: "#59a14f" }] },
                options: { responsive: false, scales: { y: { beginAtZero: true, max: 1, ticks: { callback: v => v.toFixed(1) } } } }
            });
        }
    </script>
</body>

</html>