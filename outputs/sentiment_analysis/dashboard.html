<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Sentiment-analysis Metrics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        h1 {
            margin-top: 0;
        }

        table {
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 4px 8px;
        }

        th {
            background: #f2f2f2;
        }

        #questionTable {
            margin-top: 10px;
            max-height: 350px;
            overflow-y: auto;
            display: block;
        }

        #questionTable thead,
        #questionTable tbody {
            display: block;
        }

        #questionTable tbody {
            overflow-y: auto;
            max-height: 300px;
        }

        #questionTable td {
            min-width: 120px;
        }
    </style>
</head>

<body>
    <h1>Sentiment-analysis Metrics Dashboard</h1>

    <label for="modelSelect"><strong>Select model run:</strong></label>
    <select id="modelSelect"></select>

    <h2>Overall statistics</h2>
    <table id="statsTable">
        <thead>
            <tr>
                <th>Metric</th>
                <th>Value</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h2>Difference-jump counts</h2>
    <canvas id="jumpChart" width="640" height="320"></canvas>

    <h2>Accuracy comparison across models</h2>
    <canvas id="accuracyChart" width="640" height="320"></canvas>

    <h2>Question-level statistics</h2>
    <details open>
        <summary>Toggle table</summary>
        <table id="questionTable">
            <thead>
                <tr>
                    <th>Question&nbsp;ID</th>
                    <th>Before&nbsp;mean</th>
                    <th>After&nbsp;mean</th>
                    <th>Diff&nbsp;mean</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </details>

    <h2>Accuracy by question type (selected model)</h2>
    <canvas id="typeAccChart" width="640" height="320"></canvas>

    <h2>Accuracy comparison – models vs question types</h2>
    <canvas id="modelTypeChart" width="800" height="420"></canvas>

    <p style="color:#666; font-size:0.9em; margin-top: 32px;">
        Tip: If the browser blocks loading of local JSON files, serve this folder with a simple server
        (e.g.&nbsp;<code>python -m http.server</code>) and open <code>http://localhost:8000</code>.
    </p>

    <script>
        // Mapping of display label to JSON filename (relative to this HTML file)
        const fileMap = [
            {
                label: "deepseek-chat",
                path: "sentiment_analysis_free_response_deepseek-chat_20250623-180649_20250624-013240.json"
            },
            {
                label: "gpt-4o-mini",
                path: "sentiment_analysis_free_response_gpt-4o-mini_20250623-102646_20250624-013240.json"
            },
            {
                label: "claude-3-5-haiku",
                path: "sentiment_analysis_free_response_claude-3-5-haiku-latest_20250623-182351_20250624-013240.json"
            },
            {
                label: "gpt-4o",
                path: "sentiment_analysis_free_response_gpt-4o_20250623-111016_20250624-013240.json"
            },
            {
                label: "o4-mini",
                path: "sentiment_analysis_free_response_o4-mini_20250624-004707_20250624-013240.json"
            }
        ];

        const modelSelect = document.getElementById("modelSelect");
        const statsBody = document.querySelector("#statsTable tbody");
        const qBody = document.querySelector("#questionTable tbody");
        let jumpChart;
        let accuracyChart;
        let typeAccChart;
        let modelTypeChart;

        // Populate <select>
        fileMap.forEach((f, idx) => {
            const opt = document.createElement("option");
            opt.value = idx;
            opt.textContent = f.label;
            modelSelect.appendChild(opt);
        });

        // Load all JSON files in parallel
        Promise.all(
            fileMap.map(f => fetch(f.path).then(r => {
                if (!r.ok) throw new Error(`Failed to load ${f.path}`);
                return r.json();
            }))
        ).then(jsonArr => {
            jsonArr.forEach((js, i) => fileMap[i].data = js);
            // After all loaded: build accuracy chart
            renderAccuracyChart();
            renderModelTypeChart();
            // Initial render
            updateView(0);
            modelSelect.addEventListener("change", e => updateView(+e.target.value));
        }).catch(err => {
            console.error(err);
            alert("Error loading JSON files – see console for details.  If you're opening this file directly, try running a local web-server instead.");
        });

        function updateView(idx) {
            const dataset = fileMap[idx].data;
            if (!dataset) return;
            renderStats(dataset.overall_stats);
            renderJumpChart(dataset.overall_stats.difference_jump_counts || {});
            renderQuestionStats(dataset.question_stats);
            renderTypeAccChart(dataset.type_stats || {});
        }

        // ----- overall-stats table -----
        function renderStats(stats) {
            statsBody.innerHTML = "";
            const metricKeys = [
                "mean_before_score",
                "mean_after_score",
                "mean_difference",
                "accuracy",
                "overall_consistency_before",
                "overall_consistency_after"
            ];
            metricKeys.forEach(k => {
                const tr = document.createElement("tr");
                const name = k.replace(/_/g, " ");
                const val = (typeof stats[k] === "number") ? stats[k].toFixed(3) : stats[k];
                tr.innerHTML = `<td>${name}</td><td>${val}</td>`;
                statsBody.appendChild(tr);
            });
        }

        // ----- bar chart for jump counts -----
        function renderJumpChart(counts) {
            const labels = Object.keys(counts).sort();
            const values = labels.map(l => counts[l]);
            if (!jumpChart) {
                jumpChart = new Chart(document.getElementById("jumpChart").getContext("2d"), {
                    type: "bar",
                    data: {
                        labels,
                        datasets: [{ label: "Count", data: values, backgroundColor: "#4e79a7" }]
                    },
                    options: {
                        responsive: false,
                        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                    }
                });
            } else {
                jumpChart.data.labels = labels;
                jumpChart.data.datasets[0].data = values;
                jumpChart.update();
            }
        }

        // ----- question-level table -----
        function renderQuestionStats(qStats) {
            qBody.innerHTML = "";
            Object.entries(qStats).forEach(([qid, obj]) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${qid}</td><td>${obj.before_score_mean.toFixed(2)}</td><td>${obj.after_score_mean.toFixed(2)}</td><td>${obj.difference_mean.toFixed(2)}</td>`;
                qBody.appendChild(tr);
            });
        }

        // ----- accuracy comparison chart -----
        function renderAccuracyChart() {
            const labels = fileMap.map(f => f.label);
            const values = fileMap.map(f => f.data.overall_stats.accuracy ?? 0);
            accuracyChart = new Chart(document.getElementById("accuracyChart").getContext("2d"), {
                type: "bar",
                data: {
                    labels,
                    datasets: [{ label: "Accuracy", data: values, backgroundColor: "#59a14f" }]
                },
                options: {
                    responsive: false,
                    scales: {
                        y: { beginAtZero: true, max: 1, ticks: { callback: v => v.toFixed(1) } }
                    }
                }
            });
        }

        // ----- accuracy per type -----
        function renderTypeAccChart(typeStats) {
            const labels = Object.keys(typeStats);
            const values = labels.map(l => typeStats[l].accuracy ?? 0);
            if (!typeAccChart) {
                typeAccChart = new Chart(document.getElementById("typeAccChart").getContext("2d"), {
                    type: "bar",
                    data: { labels, datasets: [{ label: "Accuracy", data: values, backgroundColor: "#e15759" }] },
                    options: { responsive: false, scales: { y: { beginAtZero: true, max: 1 } } }
                });
            } else {
                typeAccChart.data.labels = labels;
                typeAccChart.data.datasets[0].data = values;
                typeAccChart.update();
            }
        }

        // ----- grouped chart: models vs types -----
        function renderModelTypeChart() {
            const allTypes = Array.from(new Set(fileMap.flatMap(f => Object.keys(f.data.type_stats || {})))).sort();
            const palette = ["#4e79a7", "#f28e2b", "#e15759", "#76b7b2", "#59a14f", "#edc948", "#b07aa1", "#ff9da7"];
            const datasets = fileMap.map((f, idx) => {
                const data = allTypes.map(t => {
                    const entry = (f.data.type_stats || {})[t];
                    return entry ? entry.accuracy ?? null : null;
                });
                return { label: f.label, data, backgroundColor: palette[idx % palette.length] };
            });
            modelTypeChart = new Chart(document.getElementById("modelTypeChart").getContext("2d"), {
                type: "bar",
                data: { labels: allTypes, datasets },
                options: {
                    responsive: false,
                    scales: {
                        x: { stacked: false },
                        y: { beginAtZero: true, max: 1 }
                    },
                    plugins: {
                        legend: { position: "top" },
                        title: { display: false }
                    }
                }
            });
        }
    </script>
</body>

</html>